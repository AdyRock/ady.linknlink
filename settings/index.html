<!doctype html>
<html>

<head>
	<link rel="stylesheet" type="text/css" href="lwsa.css">
	<link rel="stylesheet" type="text/css" href="busy_indicator.css" />
	<link rel="stylesheet" type="text/css" href="extraStyles.css">
	<link rel='stylesheet' href='https://cdn-uicons.flaticon.com/uicons-regular-rounded/css/uicons-regular-rounded.css'>

	<style type="text/css">
		.fog_div {
			display: none;
			position: fixed;
			top: 0px;
			left: 0px;
			height: 100%;
			width: 100%;
			z-index: 100;
			background-color: rgba(30, 30, 30, 0.5);
		}

		#busybox.show {
			display: block;
		}
	</style>

	<!-- The '/homey.js' script must be included in your settings view to work -->
	<script type="text/javascript" src="/homey.js" data-origin="settings"></script>
	<script type="text/javascript" src="busy_indicator.js"></script>
</head>

<body>
	<!-- Busy indicator -->
	<div id="busybox" class="fog_div">
		<div></div>
	</div>

	<!-- Tab links -->
	<div class="tab">
		<button class="tablinks" onclick="setPage(event, 'settings')" id="defaultOpen"><span
				data-i18n="settings.settings"></span></button>
		<button class="tablinks" onclick="setPage(event, 'detected')">Detected</button>
		<button class="tablinks" onclick="setPage(event, 'log')">Log</button>
	</div>

	<!-- Settings-->
	<div id="settings" class="tabcontent">
		<fieldset class="homey-form-fieldset">
			<p id="introText" data-i18n="settings.intro"></p>
			<p id="response"></p>
			<fieldset class="homey-form-fieldset">
				<legend class="homey-form-legend" data-i18n="settings.logintitle"></legend>
				<span id="response"></span>
				<label class="homey-form-checkbox">
					<input class="homey-form-checkbox-input" id="useHomeyBroker" type="checkbox"
						value="useHomeyBroker" />
					<span class="homey-form-checkbox-checkmark"></span>
					<span class="homey-form-checkbox-text"><span data-i18n="settings.useHomeyBroker"></span></span>
				</label>
				<div class="field row">
					<label class="homey-form-label" for="brokerURL" data-i18n="settings.brokerURL"></label>
					<input class="homey-form-input" id="brokerURL" type="text" value="" />
				</div>
				<div class="field row">
					<label class="homey-form-label" for="brokerPort" data-i18n="settings.brokerPort"></label>
					<input class="homey-form-input" id="brokerPort" type="text" value="" />
				</div>
				<div class="field row">
					<label class="homey-form-label" for="brokerWSPort" data-i18n="settings.brokerWSPort"></label>
					<input class="homey-form-input" id="brokerWSPort" type="text" value="" />
				</div>
				<div class="field row">
					<label class="homey-form-label" for="username" data-i18n="settings.username"></label>
					<input class="homey-form-input" id="username" type="text" value="" />
				</div>
				<div class="field row">
					<label class="homey-form-label" for="password" data-i18n="settings.password"></label>
					<input class="homey-form-input" id="password" type="password" value="" />
					<label class="homey-form-checkbox">
						<input class="homey-form-checkbox-input" id="showPassword" type="checkbox"
							value="showPassword" />
						<span class="homey-form-checkbox-checkmark"></span>
						<span class="homey-form-checkbox-text"><span data-i18n="settings.show_password"></span></span>
					</label>
					<p></p>
				</div>
				<div class="field row">
					<button class="homey-button-primary-full" id="saveButton" data-i18n="settings.save"></button>
				</div>
			</fieldset>
	</div>

	<!-- detected-->
	<div id="detected" class="tabcontent">
		<fieldset>
			<p>
				<button id="getDeviceLog" class="homey-button-small" data-i18n="settings.getDevices"></button>
				<button id="clearDeviceLog" class="homey-button-small" data-i18n="settings.clear"></button>
				<button id="sendDeviceLog" class="homey-button-small" data-i18n="settings.send"></button>
			</p>
			<div class="field row">
				<textarea id="detectedDevices" class="homey-form-textarea" wrap="off"></textarea>
			</div>
		</fieldset>
	</div>

	<!-- LOG PAGE -->
	<div id="log" class="tabcontent">
		<fieldset class="homey-form-fieldset">
			<label class="homey-form-checkbox">
				<input class="homey-form-checkbox-input" id="enableLog" type="checkbox" value="auto" />
				<span class="homey-form-checkbox-checkmark"></span>
				<span class="homey-form-checkbox-text"><span data-i18n="settings.enableLog"></span></span>
				<div class="tooltip"><i class="fi fi-rr-info"></i>
					<span class="tooltiptext" data-i18n="settings.enableLogExplanation"></span>
				</div>
			</label>
			<div class="field row">
				<label class="homey-form-label" for="email"><span data-i18n="settings.email"></span>
					<div class="tooltip"><i class="fi fi-rr-info"></i>
						<span class="tooltiptext" data-i18n="settings.emailExplanation"></span>
					</div>
				</label>
				<input class="homey-form-input" id="email" type="text" value />
				<label class="homey-form-label" for="description"><span data-i18n="settings.description"></span>
					<div class="tooltip"><i class="fi fi-rr-info"></i>
						<span class="tooltiptext" data-i18n="settings.descriptionExplanation"></span>
					</div>
				</label>
				<input class="homey-form-input" id="description" type="text" value />
				<p></p>
			</div>
			<p>
				<button id="clearInfoLog" class="homey-button-small" data-i18n="settings.clear"></button>
				<button id="sendInfoLog" class="homey-button-small" data-i18n="settings.send"></button>
			</p>
			<div class="field row">
				<textarea id="infoLog" class="homey-form-textarea" wrap="off"></textarea>
			</div>
		</fieldset>
	</div>

	<script type="text/javascript">
		// Create the busy indicator
		var busyi;
		busyi = new busy_indicator(document.getElementById("busybox"), document.querySelector("#busybox div"));

		// Settings tab
		var saveButton = document.getElementById('saveButton');
		var response = document.getElementById('response');
		var usernameEl = document.getElementById('username');
		var passwordEl = document.getElementById('password');
		var showPasswordEl = document.getElementById('showPassword');
		var brokerURLEl = document.getElementById('brokerURL');
		var brokerPortEl = document.getElementById('brokerPort');
		var brokerWSPortEl = document.getElementById('brokerWSPort');
		var useHomeyBrokerEl = document.getElementById('useHomeyBroker');

		var detectedDevicesElement = document.getElementById('detectedDevices');
		var infoLogElement = document.getElementById('infoLog');
		var logEnabledElement = document.getElementById('enableLog');
		var clearInfoLogElement = document.getElementById('clearInfoLog');
		var sendInfoLogElement = document.getElementById('sendInfoLog');

		var getDeviceLogElement = document.getElementById('getDeviceLog');
		var clearDeviceLogElement = document.getElementById('clearDeviceLog');
		var sendDeviceLogElement = document.getElementById('sendDeviceLog');
		var emailElement = document.getElementById('email');
		var descriptionElement = document.getElementById('description');

		// a method named 'onHomeyReady' must be present in your code
		function onHomeyReady(Homey)
		{
			// Tell Homey we're ready to be displayed
			Homey.ready();

			document.getElementById("defaultOpen").click();

			Homey.api('GET', '/getInfoLog/',
				{
					notify: true
				}, function (err, result)
			{
				if (err)
				{
					Homey.alert(err);
				}
				else
				{
					infoLogElement.value = result;
				}
			});

			Homey.on('ady.linknlink.logupdated', function (data)
			{
				infoLogElement.value = data.log;
			});

			Homey.get('logEnabled', function (err, logEnabled)
			{
				if (err) return Homey.alert(err);
				logEnabledElement.checked = logEnabled;
			});

			Homey.get('brokerSettings', function (err, brokerSettings)
			{
				if (err) return Homey.alert(err);
				useHomeyBrokerEl.checked = brokerSettings.useHomeyBroker;
				brokerURLEl.value = brokerSettings.url;
				brokerPortEl.value = brokerSettings.port;
				brokerWSPortEl.value = brokerSettings.wsport;
				usernameEl.value = brokerSettings.username;
				passwordEl.value = brokerSettings.password;
			});

			useHomeyBrokerEl.addEventListener('click', function (e)
			{
				// Disable/enable the broker URL fields
				brokerURLEl.disabled = useHomeyBrokerEl.checked;

				// Fill in the HOMEY broker details if selected
				if (useHomeyBrokerEl.checked)
				{
					brokerURLEl.value = "localhost";
					brokerPortEl.value = "10883";
					brokerWSPortEl.value = "18888";
				}
				else
				{
					brokerURLEl.value = "";
					brokerPortEl.value = "";
					brokerWSPortEl.value = "";
				}
			});

			showPasswordEl.addEventListener('click', function (e)
			{
				if (passwordEl.type === "password")
				{
					passwordEl.type = "text";
				}
				else
				{
					passwordEl.type = "password";
				}
			});

			saveButton.addEventListener('click', function ()
			{
				Object.values(document.querySelectorAll('*')).forEach(element => element.style.cursor = "wait");
				response.innerHTML = __('settings.save_verifying');
				const useHomeyBroker = useHomeyBrokerEl.checked;
				const username = usernameEl.value;
				const password = passwordEl.value; // Changed var to const for consistency
				const brokerURL = brokerURLEl.value;
				const brokerPort = brokerPortEl.value;
				const brokerWSPort = brokerWSPortEl.value;

				if (brokerURL.length < 7)
				{
					Object.values(document.querySelectorAll('*')).forEach(element => element.style.cursor = "default");
					response.style.color = 'red';
					response.innerHTML = __('settings.login_failure') + '<br/>' + __('settings.invalid_broker_ip');
					return Homey.alert(__('settings.invalid_broker_ip'));
				}
				if (brokerPort.length < 2 || isNaN(brokerPort))
				{
					Object.values(document.querySelectorAll('*')).forEach(element => element.style.cursor = "default");
					response.style.color = 'red';
					response.innerHTML = __('settings.login_failure') + '<br/>' + __('settings.invalid_broker_port');
					return Homey.alert(__('settings.invalid_broker_port'));
				}
				if (brokerWSPort.length < 2 || isNaN(brokerWSPort))
				{
					Object.values(document.querySelectorAll('*')).forEach(element => element.style.cursor = "default");
					response.style.color = 'red';
					response.innerHTML = __('settings.login_failure') + '<br/>' + __('settings.invalid_broker_wsport');
					return Homey.alert(__('settings.invalid_broker_wsport'));
				}

				Homey.api('POST', '/changeBroker/',
					{
						"useHomeyBroker": useHomeyBroker,
						"username": username,
						"password": password,
						"brokerURL": brokerURL,
						"brokerPort": brokerPort,
						"brokerWSPort": brokerWSPort
					}, function (err, result)
				{
					Object.values(document.querySelectorAll('*')).forEach(element => element.style.cursor = "default");
					if (err)
					{
						response.style.color = 'red';
						response.innerHTML = __('settings.login_failure') + '<br/>' + err;
						return Homey.alert(err);
					}
					response.style.color = 'green';
					response.innerHTML = __('settings.login_success');
				});
			});

			logEnabledElement.addEventListener('change', function (e)
			{
				Homey.set('logEnabled', logEnabledElement.checked, function (err)
				{
					if (err) return Homey.alert(err);
				});
			});

			getDeviceLogElement.addEventListener('click', function (e)
			{
				waitCursor(true);
				Homey.api('GET', '/getDeviceLog/',
					{
						hubDevices: true
					}, function (err, result)
				{
					if (err)
					{
						Homey.alert(err);
					}
					else
					{
						detectedDevicesElement.value = result;
					}
					waitCursor(false);
				});
			});

			clearDeviceLogElement.addEventListener('click', function (e)
			{
				Homey.set('deviceLog', "", function (err)
				{
					if (err) return Homey.alert(err);
				});
				detectedDevicesElement.value = "";
			});

			sendDeviceLogElement.addEventListener('click', function (e)
			{
				if (detectedDevicesElement.value.length < 15)
				{
					return Homey.alert(Homey.__("settings.descriptionExplanation"));
				}
				Homey.confirm(Homey.__("settings.sendLogConfirm"), null, function (e, ok)
				{
					if (ok)
					{
						waitCursor(true);
						Homey.api('POST', '/SendDeviceLog/',
							{
								notify: true,
								email: emailElement.value,
								description: descriptionElement.value,
								log: detectedDevicesElement.value,
							}, function (err, result)
						{
							if (err)
							{
								Homey.alert(err);
							}
							else
							{
								Homey.alert("Log sent successfully");
							}
							waitCursor(false);
						});
					}
				});
			});

			sendInfoLogElement.addEventListener('click', function (e)
			{
				if (infoLogElement.value.length < 15)
				{
					return Homey.alert("No Data to send");
				}

				Homey.confirm("Send the information log contents to the developer?", null, function (e, ok)
				{
					if (ok)
					{
						waitCursor(true);
						Homey.api('POST', '/sendInfoLog/',
							{
								notify: true,
								email: emailElement.value,
								description: descriptionElement.value,
								log: infoLogElement.value,
							}, function (err, result)
						{
							if (err)
							{
								Homey.alert(err);
							}
							else
							{
								Homey.alert("Log sent successfully");
							}
							waitCursor(false);
						});
					}
				});
			});

			clearInfoLogElement.addEventListener('click', function (e)
			{
				Homey.api('POST', '/clearLog/',
					{
						notify: true
					}, function (err, result)
				{
					if (err)
					{
						return Homey.alert(err);
					}
					else
					{
						infoLogElement.value = "";
					}
				});
			});


			logEnabledElement.addEventListener('click', function (e)
			{
				Homey.set('logEnabled', logEnabledElement.checked);
			});

			var tooltips = document.querySelectorAll(".tooltip");
			tooltips.forEach(function (tooltip, index)
			{
				// Set a mouse over function for each tooltop element
				tooltip.addEventListener("mouseover", position_tooltip); // On hover, launch the function below
			})
		}

		function setPage(evt, tabPage)
		{
			var i, tabcontent, tablinks;

			// Get all elements with class="tabcontent" and hide them
			tabcontent = document.getElementsByClassName("tabcontent");
			for (i = 0; i < tabcontent.length; i++)
			{
				tabcontent[i].style.display = "none";
			}

			// Get all elements with class="tablinks" and remove the class "active"
			tablinks = document.getElementsByClassName("tablinks");
			for (i = 0; i < tablinks.length; i++)
			{
				tablinks[i].className = tablinks[i].className.replace(" active", "");
			}

			// Show the current tab, and add an "active" class to the button that opened the tab
			document.getElementById(tabPage).style.display = "block";
			evt.currentTarget.className += " active";

			if (tabPage == 'log')
			{
				// Refresh the log data
				Homey.get('logEnabled', function (err, logEnabled)
				{
					if (err) return Homey.alert(err);
					logEnabledElement.checked = logEnabled;
				});

				// Make the log text area fill the page
				infoLogElement.setAttribute('cols', infoLogElement.parentElement.clientWidth / 8);
				infoLogElement.style.height = (window.innerHeight - infoLogElement.offsetTop - 60) + 'px';
			}
			else if (tabPage == 'detected')
			{
				// Make the detected devices text area fill the page
				detectedDevicesElement.setAttribute('cols', detectedDevicesElement.parentElement.clientWidth / 8);
				detectedDevicesElement.style.height = (window.innerHeight - detectedDevicesElement.offsetTop - 60) + 'px';
			}
		}
		function position_tooltip()
		{
			// Get .tooltiptext sibling
			var tooltip = this.parentNode.querySelector(".tooltiptext");

			// Get tooltip coordinates and size
			var tooltip_rect = tooltip.getBoundingClientRect();

			// Corrections if out of window
			var maxRight = window.innerWidth - 50;
			var tipRight = tooltip_rect.x + tooltip_rect.width;

			if (tipRight > maxRight)
			{
				tipX = maxRight - tipRight;

				// Apply corrected position
				if (tooltip.style.left === "")
				{
					tooltip.style.left = tipX + 'px';
				}
				else
				{
					tooltip.style.left -= tipX + 'px';
				}
			}
		}


		function waitCursor(On)
		{
			if (On)
			{
				busyi.show();
			}
			else
			{
				busyi.hide();
			}
		}
	</script>

</body>

</html>